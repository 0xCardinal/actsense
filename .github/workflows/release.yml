name: Release

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y software-properties-common
          sudo add-apt-repository -y ppa:deadsnakes/ppa
          sudo apt-get update
          sudo apt-get install -y python3.12 python3.12-venv git

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          cd backend
          uv sync

      - name: Run tests with coverage
        run: |
          cd backend
          uv run pytest --cov=. --cov-report=term-missing

  build-check:
    name: Build Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Node.js
        run: |
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs

      - name: Install patch-package globally
        run: npm install -g patch-package

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Build frontend
        run: |
          cd frontend
          npm run build

  release:
    name: Create Release
    needs: [test, build-check]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get tag name
        run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

      - name: Fetch all tags
        run: git fetch --tags --force

      - name: Generate release notes
        run: |
          set -e
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          
          # Get all tags sorted by version, excluding current tag
          PREV_TAG=$(git tag --sort=-version:refname | grep -v "^${CURRENT_TAG}$" | head -1 || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            # No previous tag found - this is the initial release
            {
              echo "RELEASE_BODY<<EOF"
              echo "## v$CURRENT_TAG"
              echo ""
              echo "Initial release of actsense."
              echo "EOF"
            } >> $GITHUB_ENV
          else
            # Generate changelog between previous tag and current tag
            # Use merge-base to handle cases where tags might not be in direct lineage
            CHANGELOG=$(git log --pretty=format:'- %s (%h)' $(git merge-base ${PREV_TAG} ${CURRENT_TAG} 2>/dev/null || echo ${PREV_TAG})..${CURRENT_TAG} 2>/dev/null || echo "")
            
            if [ -z "$CHANGELOG" ]; then
              {
                echo "RELEASE_BODY<<EOF"
                echo "## v$CURRENT_TAG"
                echo ""
                echo "### Changes since $PREV_TAG"
                echo ""
                echo "No changes found."
                echo "EOF"
              } >> $GITHUB_ENV
            else
              {
                echo "RELEASE_BODY<<EOF"
                echo "## v$CURRENT_TAG"
                echo ""
                echo "### Changes since $PREV_TAG"
                echo ""
                echo "$CHANGELOG"
                echo "EOF"
              } >> $GITHUB_ENV
            fi
          fi

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Create Release
        run: |
          set -e
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/releases \
            -d "{\"tag_name\":\"$TAG_NAME\",\"name\":\"v$TAG_NAME\",\"body\":$(echo -n \"$RELEASE_BODY\" | jq -Rs .),\"draft\":false,\"prerelease\":false}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" -eq 201 ]; then
            echo "✅ Release created successfully"
            echo "$BODY" | jq -r '.html_url' || echo "Release URL not available"
          elif [ "$HTTP_CODE" -eq 422 ]; then
            echo "⚠️ Release already exists (HTTP 422)"
            echo "$BODY" | jq -r '.message' || echo "Release already exists"
          else
            echo "❌ Failed to create release (HTTP $HTTP_CODE)"
            echo "$BODY"
            exit 1
          fi
